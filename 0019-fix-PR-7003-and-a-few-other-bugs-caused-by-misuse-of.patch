From 18c7b7f4d6ef0a1a8fc99f98133326dc1674b97f Mon Sep 17 00:00:00 2001
From: Damien Doligez <damien.doligez-inria.fr>
Date: Mon, 19 Oct 2015 15:47:33 +0000
Subject: [PATCH 19/19] fix PR#7003 and a few other bugs caused by misuse of
 Int_val

git-svn-id: http://caml.inria.fr/svn/ocaml/trunk@16525 f963ae5c-01c2-4b8c-9fe0-0dff7051ff02
(cherry picked from commit 659615c7b100a89eafe6253e7a5b9d84d0e8df74)
---
 byterun/alloc.c | 4 ++--
 byterun/str.c   | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/byterun/alloc.c b/byterun/alloc.c
index a1fd2f0..dfbdfb8 100644
--- a/byterun/alloc.c
+++ b/byterun/alloc.c
@@ -145,7 +145,7 @@ CAMLexport int caml_convert_flag_list(value list, int *flags)
 
 CAMLprim value caml_alloc_dummy(value size)
 {
-  mlsize_t wosize = Int_val(size);
+  mlsize_t wosize = Long_val(size);
 
   if (wosize == 0) return Atom(0);
   return caml_alloc (wosize, 0);
@@ -153,7 +153,7 @@ CAMLprim value caml_alloc_dummy(value size)
 
 CAMLprim value caml_alloc_dummy_float (value size)
 {
-  mlsize_t wosize = Int_val(size) * Double_wosize;
+  mlsize_t wosize = Long_val(size) * Double_wosize;
 
   if (wosize == 0) return Atom(0);
   return caml_alloc (wosize, 0);
diff --git a/byterun/str.c b/byterun/str.c
index 9a96147..d4d9a8d 100644
--- a/byterun/str.c
+++ b/byterun/str.c
@@ -269,7 +269,7 @@ CAMLprim value caml_string_greaterequal(value s1, value s2)
 CAMLprim value caml_blit_string(value s1, value ofs1, value s2, value ofs2,
                                 value n)
 {
-  memmove(&Byte(s2, Long_val(ofs2)), &Byte(s1, Long_val(ofs1)), Int_val(n));
+  memmove(&Byte(s2, Long_val(ofs2)), &Byte(s1, Long_val(ofs1)), Long_val(n));
   return Val_unit;
 }
 
@@ -296,6 +296,6 @@ CAMLprim value caml_is_printable(value chr)
 
 CAMLprim value caml_bitvect_test(value bv, value n)
 {
-  int pos = Int_val(n);
+  intnat pos = Long_val(n);
   return Val_int(Byte_u(bv, pos >> 3) & (1 << (pos & 7)));
 }
-- 
1.8.3.1

